# 批量移动分片

```shell
#!/bin/bash
# author: wyp
set -u
port=9297
url="192.168.23.10"
number_shards="$1"
# 需要移动的分片数量
#number_shards=10
# 节点列表
declare  -A  node_list
node_list=(
  ["node-3"]=""
  ["node-2"]=""
  ["node-1"]=""
)
#  定义索引列表
index_info=(
  "index_1"
  "index_2"
  "index_3"
  "index_4"
)
#################################################
function is_in {           
    local var=$1
    shift
    local item
    for item in $@
    do
    if [ "$item" == "$var"  ];then
            return 0
    fi
    done
    return 1
}
function  init_shards_number() {
    local index_name="$1"
    local node
    for node in ${!node_list[*]}
    do
        node_list[$node]=$(curl  -s $url:$port/_cat/shards/$index_name  | grep "$node" | awk  '{ print $2 }')
    done
    local tmp_list=(${!node_list[*]})
    local length=${#tmp_list[*]}
    local i
    for i in  $(seq  $[length-1])
    do
          local tmp_str=""
          local current_node=${tmp_list[ $[i-1] ]}
          local next_node=${tmp_list[$i]}
          local shard_num
          for shard_num in  ${node_list[$current_node]}
          do
              is_in $shard_num "${node_list[$next_node]}" ||  tmp_str=$tmp_str" "$shard_num
          done
          node_list[$current_node]=$tmp_str
    done
    local node=${tmp_list[ $[length-1] ]}
    node_list[$node]=""
}
function move_shards() {
    local index_name="$1"
    local tmp_list=(${!node_list[*]})
    local length=${#tmp_list[*]}
    local finished=false
    local count=-1
    local cmd_items=""
    for i  in $(seq $[length-1])
    do
        local current_node=${tmp_list[ $[i-1] ]}
        local next_node=${tmp_list[$i]}
        for num in ${node_list[$current_node]}
        do
            let count++
            if  [ $count -ge $number_shards ] ;then
              finished=true
              break
            fi
            cmd_items=$cmd_items'
{
  "move" : {
    "index" : "'''$index_name'''",
    "shard" : '''$num''',
    "from_node" : "'''$current_node'''",
    "to_node" : "'''$next_node'''"
  }
},'
        done
        $finished  && break
    done
    local move_shards_cmd='
{
  "commands" : ['''${cmd_items::-1}''']
}'
  res=$(curl -s -X POST  $url:$port/_cluster/reroute  -d "$move_shards_cmd" )
  if [ "$(echo $res | jq .acknowledged)" == "true" ];then
    echo '{ "acknowledged" : "true" , "index_name" :"'''$index_name'''" ,"number_shards" :"'''$count'''"  }' | jq
  else
    echo  $res | jq
  fi
}
function check() {
    local index_list=$(curl -s $url:$port/_cat/indices?h=index)
    local index
    for index in ${index_info[*]}
    do
       if ! is_in $index "$index_list";then
          echo "ERROR: Hava not this index '$index'"
          exit
       fi
    done
    local nodes=$(curl -s $url:$port/_cat/nodes?h=name)
    local node
    for node in ${!node_list[*]}
    do
        if ! is_in  $node "$nodes" ;then
            echo "ERROR: Have not this node '$node'"
        fi
    done
}
function main() {
    check
    local index_name
    for index_name in ${index_info[*]}
    do
         init_shards_number "$index_name"
         move_shards "$index_name"
    done
}
main
```