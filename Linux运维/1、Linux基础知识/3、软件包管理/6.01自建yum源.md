# 1、准备工作

1）准备两台虚拟机：server1，server2;

2）server1关闭防火墙：

```
[root@server1 ~]# systemctl stop firewalld    #关闭防火墙
[root@server1 ~]# systemctl status firewalld
● firewalld.service - firewalld - dynamic firewall daemon
   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; disabled; vendor preset: enabled)
   Active: inactive (dead)
     Docs: man:firewalld(1)
[root@server1 ~]# getenforce     #查看selinux状态
Enforcing        #开启中
[root@server1 ~]# setenforce  0  #关闭selinux，临时关闭，1为开启防火墙
[root@server1 ~]# vim /etc/selinux/config     #永久关闭selinux


SELINUX=disabled    #将enforcing改为disable
```

3)下载vsftp服务，并启动；

```
[root@server1 ~]# yum install -y vsftpd.x86_64    #下载
[root@server1 ~]# systemctl start vsftpd           #启动vsftp服务
[root@server1 ~]# systemctl status vsftpd          #查看状态
● vsftpd.service - Vsftpd ftp daemon
   Loaded: loaded (/usr/lib/systemd/system/vsftpd.service; disabled; vendor preset: disabled)
   Active: active (running) since 四 2022-02-10 14:25:46 GMT; 5s ago
  Process: 16467 ExecStart=/usr/sbin/vsftpd /etc/vsftpd/vsftpd.conf (code=exited, status=0/SUCCESS)
 Main PID: 16468 (vsftpd)
   CGroup: /system.slice/vsftpd.service
           └─16468 /usr/sbin/vsftpd /etc/vsftpd/vsftpd.conf

2月 10 14:25:46 server1 systemd[1]: Starting Vsftpd ftp daemon...
2月 10 14:25:46 server1 systemd[1]: Started Vsftpd ftp daemon.
[root@server1 ~]# systemctl enable vsftpd    #设置开机自启
Created symlink from /etc/systemd/system/multi-user.target.wants/vsftpd.service to /usr/lib/systemd/system/vsftpd.service.
```

## 4）测试vsftp服务

A：进入到ftp服务文件目录下，并创建一个新目录，然后创建一个文件

```
[root@server1 packages]# cd /var/ftp/
[root@server1 ftp]# mkdir update
[root@server1 ftp]# ls
pub  update
[root@server1 ftp]# cd update/
[root@server1 update]# touch test
[root@server1 update]# ls
test
```

B：尝试用server2下载这个文件，若能下载，则测试成功！！

```
[root@server1 ~]# wget ftp://192.168.10.135/update/* 
[root@server1 ~]# ls
anaconda-ks.cfg  test
```

# 2、获取rpm包并创建源的数据库

程序在下载rpm，安装完成后会自动清理rpm包，即使不安装也会清理。

所以要设置开启yum缓存。

## 1）开启yum缓存：vim /etc/yum.conf 修改： keepcache=1

```
[root@server1 packages]# vim /etc/yum.conf 

[main]
cachedir=/var/cache/yum/$basearch/$releasever
keepcache=1    #改为1
```

## 2）可以使用yum update --downloadonly 或者 yum update -y

## 3）将rpm包全部复制vsftpd服务的目录下

```
[root@server1 packages]# cp -r ./* /var/ftp/update/
[root@server1 packages]# cd /var/ftp/update/
```

## 4）创建源的数据库，（yum install createrepo)

```
[root@server1 update]# yum install -y createrepo    #下载
[root@server1 update]# createrepo /var/ftp/update   #在/var/ftp/update目录下创建源的数据库
Spawning worker 0 with 21 pkgs
Spawning worker 1 with 21 pkgs
Spawning worker 2 with 21 pkgs
Spawning worker 3 with 20 pkgs
Workers Finished
Saving Primary metadata
Saving file lists metadata
Saving other metadata
Generating sqlite DBs
Sqlite DBs complete
[root@server1 update]# ls | grep repodata    #查看
repodata            #创建成功
```

# 3、更改sever2的yum的配置文件（更改源）

## 1）删除或者修改repo文件

```
[root@server1 ~]# cd /etc/yum.repos.d/
[root@server1 yum.repos.d]# ls
CentOS-Base.repo  CentOS-CR.repo  CentOS-Debuginfo.repo  CentOS-fasttrack.repo  CentOS-Media.repo  CentOS-Sources.repo  CentOS-Vault.repo
[root@server1 yum.repos.d]# rm -f ./*
[root@server1 yum.repos.d]# ls
```

## 2）新建repo文件

```
[root@server1 yum.repos.d]# vim update.repo

[update]
name=sever1.update
baseurl=ftp://192.168.10.135/update
gpgcheck=0    #关闭数字证书
enabled=1    #启用
```

## 3）yum clean all;yum makecache;yum repolist

```
[root@server1 yum.repos.d]# yum clean all
已加载插件：fastestmirror
正在清理软件源： update
[root@server1 yum.repos.d]# yum makecache 
已加载插件：fastestmirror
Determining fastest mirrors
update                                                                                                                                  | 2.9 kB  00:00:00     
(1/3): update/filelists_db                                                                                                              |  45 kB  00:00:00     
(2/3): update/primary_db                                                                                                                |  62 kB  00:00:00     
(3/3): update/other_db                                                                                                                  |  50 kB  00:00:00     
元数据缓存已建立
[root@server1 yum.repos.d]# yum repolist 
已加载插件：fastestmirror
Loading mirror speeds from cached hostfile
源标识                                                                    源名称                                                                           状态
update                                                                    sever1.update                                                                    83
repolist: 83
```

## 4)测试yum install -y [软件名]

```
[root@server1 yum.repos.d]# yum install make.x86_64
```