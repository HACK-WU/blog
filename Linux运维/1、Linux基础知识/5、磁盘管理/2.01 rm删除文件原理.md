# **linux rm删除文件原理**

很多时候，我们都会发现，某个进程在对当前文件读写，但是我们依然能够rm， 是不是很奇怪？而windows下面，肯定会报错，”当前文件正在被使用“， 这就得从linux下面删除文件的原理说起了。

　　 Linux是通过link的数量来控制文件删除的，只有当一个文件不存在任何link的时候，这个文件才会被删除。一般来说，每个文件都有2个link计数器:i_count 和 i_nlink。　　

　　 i_count的意义是当前文件使用者（或被调用）的数量,i_nlink 的意义是介质连接的数量（硬链接的数量）；可以理解为i_count是内存引用计数器，i_nlink是磁盘的引用计数器。　　

　　当一个文件被某一个进程引用时，对应i_count数就会增加；当创建文件的硬链接的时候，对应i_nlink数就会增加。　　

　　 对于删除命令rm而言，实际就是减少磁盘引用计数i_nlink。这里就会有一个问题，如果一个文件正在被某个进程调用，而用户却执行rm操作把文件删除了，那么会出现什么结果呢？当用户执行rm操作删除文件后，再执行ls或者其他文件管理命令，无法再找到这个文件了，但是调用这个删除的文件的进程却在继续正常执行，依然能够从文件中正确的读取及写入内容。这又是为什么呢？　　

　　这是因为rm操作只是将文件的i_nlink减少了，如果没其它的链接i_nlink就为0了；但由于该文件依然被进程引用，因此，此时文件对应的i_count并不为0，所以即使执行rm操作，但系统并没有真正删除这个文件，当只有i_nlink及i_count都为0的时候，这个文件才会真正被删除。也就是说，还需要解除该进程的对该文件的调用才行。　　

　　以上讲的i_nlink及i_count是文件删除的真实条件，但是当文件没有被调用时，执行了rm操作删除文件后是否还可以找回被删的文件呢？　　

　　前面说了，rm操作只是将文件的i_nlink减少了，或者说置0了，实际就是将文件名到inode的链接删除了，此时，并没有删除文件的实体即（block数据块），此时，如果及时停止机器工作，数据是可以找回的，如果此时继续写入数据，那么当新数据就可能会被分配到被删除的数据的block数据块，此时，文件就会被真正的回收了 

备注：根据以上原理，实际情况会出现以下问题，web服务器磁盘空间不够了，删除了所有无用日志还是先是磁盘空间不足，但是用du -sh /*发现磁盘空间占用的远小于硬盘总大小，这就是因为只删除了一个i_nlink，而还有其他进程在使用着这些log文件，apache或者tomcat，重启再看就ok了。

### 一、现象描述

操作系统：CentOS 6.8 x64　　使用 df -h 命令，看见 / 根目录下磁盘空间已满（100%），于是手动清理大日志文件。

```javascript
[root@local ~]# df -h
Filesystem                    Size  Used Avail Use% Mounted on
/dev/mapper/rootvg-LogVol00    59G   59G     0 100% /
/dev/sda1                     190M   13M  168M   8% /boot
tmpfs                         2.0G     0  2.0G   0% /dev/shm
```

复制

　　通过 du -sh 命令，找到占用大量空间的日志文件，于是使用 rm -rf  删除了它。

```javascript
[root@local ~]# cd /var/nginx/logs/
[root@local ~]# rm -rf t-access.log t-error.log
```

复制

　　然后 查看磁盘空间的使用情况，发现 / (根目录）的空间并没有发生变化。但是可以看到 Used 发生了变化。

```javascript
[root@local ~]# df -h
Filesystem                    Size  Used Avail Use% Mounted on
/dev/mapper/rootvg-LogVol00    59G   56G     0 100% /
/dev/sda1                     190M   13M  168M   8% /boot
tmpfs                         2.0G     0  2.0G   0% /dev/shm
```

复制

这是怎么回事呢？

二、原因未释放磁盘空间的原因：　　在Linux或者Unix系统中，通过rm或者文件管理器删除文件将会从文件系统的文件夹结构上解除链接(unlink)，然而假设文件是被打开的（有一个进程正在使用），那么进程将仍然能够读取该文件，磁盘空间也一直被占用。而我删除的是nginx的访问日志文件，在删除的时候该文件正在被使用。 

三、解决办法　　首先获得一个已经被删除的可是仍然被应用程序占用的文件列表。操作如下：

```javascript
[root@local ~]# lsof |grep deleted
nginx      4399      root   38w      REG              253,0   19304448   10835682 /var/nginx/logs/t-access.log (deleted)
nginx      4399      root   39w      REG              253,0    3502080   10835684 /var/nginx/logs/t-error.log (deleted)
nginx      4401    nobody   38w      REG              253,0   19304448   10835682 /var/nginx/logs/t-access.log (deleted)
nginx      4401    nobody   39w      REG              253,0    3502080   10835684 /var/nginx/logs/t-error.log (deleted)
nginx      4402    nobody   38w      REG              253,0   19304448   10835682 /var/nginx/logs/t-access.log (deleted)
nginx      4402    nobody   39w      REG              253,0    3502080   10835684 /var/nginx/logs/t-error.log (deleted)
nginx      4403    nobody   38w      REG              253,0   19304448   10835682 /var/nginx/logs/t-access.log (deleted)
nginx      4403    nobody   39w      REG              253,0    3502080   10835684 /var/nginx/logs/t-error.log (deleted)
nginx      4404    nobody   38w      REG              253,0   19304448   10835682 /var/nginx/logs/t-access.log (deleted)
nginx      4404    nobody   39w      REG              253,0    3502080   10835684 /var/nginx/logs/t-error.log (deleted)
```

复制

　　从输出的结果可以看到 /var/nginx/logs/t-access.log 和 t-error.log 还在被使用中，所以导致未释放空间。那么如何让进程释放呢？方法1：直接 kill 掉相应的进程，或者停掉使用这个文件的应用，让操作系统自己主动回收磁盘空间。　　由于还有其他项目正在使用该应用（nginx服务），所以不能停掉nginx服务，于是使用 kill 命令删除相应的进程。

```javascript
[root@local ~]# kill -9 4399
[root@local ~]# kill -9 4401
[root@local ~]# kill -9 4402
[root@local ~]# kill -9 4403
[root@local ~]# kill -9 4404
```

复制

再次，查看磁盘空间的使用情况，发现空间已经被回收了。

```javascript
[root@local ~]# df -h
Filesystem                    Size  Used Avail Use% Mounted on
/dev/mapper/rootvg-LogVol00    59G   56G     0  95% /
/dev/sda1                     190M   13M  168M   8% /boot
tmpfs                         2.0G     0  2.0G   0% /dev/shm
```

复制

方法2：以后清理正在被读写的大日志文件时，直接使用 echo "" > xxx.log 命令，即直接将文件置空，并不影响服务的使用，文件大小也被控制下来，磁盘空间也释放了。

说明：　　当Linux打开一个文件的时候,Linux内核会为每个进程在/proc/ 『/proc/nnnn/fd/文件夹（nnnn为pid）』建立一个以其pid为名的文件夹用来保存进程的相关信息，而其子文件夹fd保存的是该进程打开的全部文件的fd（fd：file descriptor）。　　kill进程是通过截断proc文件系统中的文件能够强制要求系统回收分配给正在使用的的文件。这是一项高级技术，仅到管理员确定不会对执行中的进程造成影响时使用。应用程序对这样的方式支持的并不好，当一个正在使用的文件被截断可能会引发不可预知的问题。

四、删除原理  　　一般来说，不会出现删除文件后空间不释放的情况，但是也存在例外，比如文件被进程锁定，或者有进程在使用这个文件，例如输出日志文件，要了解这个问题，就需要知道Linux下文件的存储机制和存储结构。　　一个文件在文件系统中由两个部分构成：数据和指针。指针位于文件系统的meta-data中，数据被删除后，指针被清除，而数部分还是存储在磁盘中，只不过数据对应的指针被清除后，文件数据部分占用的空间就可以被覆盖了。之所以出现删除大文件后，空间还没有释放，就是因为有进程一直在使用这个文件的指针，日志文件的服务还在运行，导致虽然删除了日志大文件，但文件对应的指针部分由于被进程锁定，并未从meta-data中清除，而由于指针并未被删除，那么系统就认为文件并未被删除，所以使用 df 命令查看还是 100%。