# **1、Walkthrough: Change/replace a drive**

- Set the drive offline, if it is not already offline due to an error

```
MegaCli64 -PDOffline -PhysDrv [E:S] -aN
```

- Mark the drive as missing

```
MegaCli64 -PDMarkMissing -PhysDrv [E:S] -aN
```

- Prepare drive for removal

```
MegaCli64 -PDPrpRmv -PhysDrv [E:S] -aN
```

- Change/replace the drive

- If youâ€™re using hot spares then the replaced drive should become your new hot spare drive:

```
MegaCli64 -PDHSP -Set -PhysDrv [E:S] -aN
```

- In case youâ€™re not working with hot spares, you must re-add the new drive to your RAID virtual drive and start the rebuilding

```
MegaCli64 -PdReplaceMissing -PhysDrv [E:S] -ArrayN -rowN -aN
MegaCli64 -PDRbld -Start -PhysDrv [E:S] -aN
```

- Testing Sas Disks

To Test SAS Disk's you need to run the following commands:

The command below will give you all the device Id's for each drive on the raid card.

The Device ID's are in order of what cable there plugged into on the Raid Card.

```
megacli64 -pdlist -a0| grep 'Device Id'
Device Id: 4 - First Device
Device Id: 5 - Second Device
```

This can now be specified as a "megaraid" option, for example:

```
smartctl -d megaraid,N -a Device |grep Elements
```

N = Device ID

Device = /dev/sda,b,c - Where a = First array b = Second Array etc

You will get a output like below:

Elements in grown defect list: 0

If number is higher then 0 then drive is dying. Mark drive as faulty

# 2、DISK MARKED AS FOREIGN ？

Some times when you replace a disk you may find the new disk marked as “Foreign”. The “Foreign” state means the controller has detected a raid signature on this disk from a previous configuration. 

This will prevent you from using the disk before the foreign state is cleared out. In order to use the disk we can clear this attribute using the MegaCli tool.

- Changing the status from Bad to good

```
# MegaCli64 -PDMakeGood -PhysDrv [<enclosure#>:<slot#>] -a<# or ALL>
root@localhost MegaCli]# ./MegaCli64 -PDMakeGood -PhysDrv[252:0] -aALL
 Adapter: 0: EnclId-252 SlotId-0 state changed to Unconfigured-Good.
 Exit Code: 0x00
 [root@localhost MegaCli]#
```

- Clear the foreign setting

```
 # MegaCli64 -CfgForeign -Clear -a<# or ALL>
 [root@localhost MegaCli]# ./MegaCli64 -CfgForeign -Clear -aALL
 Foreign configuration 0 is cleared on controller 0.
 Exit Code: 0x00
 [root@localhost MegaCli]#
```