**案例，定时备份**

- 客户端需求

- 1.客户端提前准备存放的备份的目录，目录规则如下:/backup/主机IP时间

- ⒉客户端在本地打包备份(系统配置文件、应用配置等)拷贝至/backup/主机IP时间

- 3.客户端最后将备份的数据进行推送至备份服务器

- 4.客户端每天凌晨1点定时执行该脚本

- 5.客户端服务器本地保留最近7天的数据,避免浪费磁盘空间

- 服务端需求

- 1.服务端部署rsync，用于接收客户端推送过来的备份数据

- ⒉.服务端需要每天校验客户端推送过来的数据是否完整

- 3.服务端需要每天校验的结果通知给管理员

- 4.服务端仅保留6个月的备份数据,其余的全部删除

# 1、客户端准备

## 1）创建目录

```auto
[root@server2 ~]# mkdir /backup
```

## 2）安装expect工具

```auto
[root@server2 ~]# yum install expect* -y
```

## 3）准备expect脚本

```auto
[root@server2 ~]# vim rsync.exp
#!/usr/bin/expect
set mulu [lindex $argv 0]
set timeout 10
spawn rsync -avzr /backup/$mulu root@192.168.80.10::backup_server
expect Password
send "123456\r"
expect eof
```

## 4）准备备份脚本

```auto
[root@server2 ~]# vim beifen.sh
#!/bin/bash
# 准备压缩文件的目录
mulu=`ip a | grep global|awk -F'[ /]+' '{print $3}'`_`date +%F`
echo $mulu
mkdir -pv /backup/$mulu &> /dev/null
# 打包待发送的数据
tar zcf /backup/$mulu/conf.tar.gz /etc/passwd /etc/vimrc &> /dev/null
touch /backup/$mulu
# 发送数据
#rsync -avzr /backup/$mulu root@192.168.80.10::backup_server
expect rsync.exp $mulu
# 保留七天以内的数据
find /backup -mtime +7 -delete
```

## 5）计划任务

```auto
[root@server2 ~]# cat /etc/crontab
......
0 1 * * * root /root/beifen.sh
```

# 2、服务端准备

## 1)安装rsync

```auto
[root@server1 ~]# yum install rsync.x86_64 -y 
```

## 2)修改配置文件

```auto
[root@server1 ~]# cat /etc/rsyncd.conf
[backup_server]
path = /backup
uid = root
gid = root
max connections = 2
timeout = 300
read only = false
auth users = root
secrets file = /etc/rsync.passwd
strict modes = yes
use chroot = yes
```

## 3)创建目录

```auto
[root@server1 ~]# mkdir /backup -pv 
```

## 4)准备密码文件

```auto
[root@server1 ~]# cat /etc/rsync.passwd
root:123456
[root@server1 ~]# chmod 600 /etc/rsync.passwd
```

## 5)启动rsync

```auto
[root@server1 ~]# systemctl start rsyncd.service
[root@server1 ~]# ss -tnl
State    Recv-Q Send-Q                     Local
Address:Port                            Peer
Address:Port       
LISTEN    0    128                           
*:22                                   *:*
        
LISTEN    0    100                       
 127.0.0.1:25                                
  *:*         
LISTEN    0    5                            
*:873                                  *:*
        
LISTEN    0    128                           
:::22                                  :::*
        
LISTEN    0    100                          
::1:25                                 
:::*         
LISTEN    0    5                            
:::873                                  :::*
```

## 6)验证服务端

```auto
[root@server2 ~]# rsync --list-only root@192.168.80.10::
backup_server
```

## 7)模拟一个月的数据来验证结果

```auto
[root@server2 ~]# for i in {1..30};do date -s 2021/08/$i; /root/beifen.sh ;
done
[root@server2 backup]# ll
总用量 0
drwxr-xr-x 2 root root 25 8月  23 00:00 192.168.80.20_2021-08-23
drwxr-xr-x 2 root root 25 8月  24 00:00 192.168.80.20_2021-08-24
drwxr-xr-x 2 root root 25 8月  25 00:00 192.168.80.20_2021-08-25
drwxr-xr-x 2 root root 25 8月  26 00:00 192.168.80.20_2021-08-26
drwxr-xr-x 2 root root 25 8月  27 00:00 192.168.80.20_2021-08-27
drwxr-xr-x 2 root root 25 8月  28 00:00 192.168.80.20_2021-08-28
drwxr-xr-x 2 root root 25 8月  29 00:00 192.168.80.20_2021-08-29
drwxr-xr-x 2 root root 25 8月  30 00:00 192.168.80.20_2021-08-30
[root@server1 backup]# ll
总用量 0
drwxr-xr-x 2 root root 25 8月  1 00:00 192.168.80.20_2021-08-01
drwxr-xr-x 2 root root 25 8月  2 00:00 192.168.80.20_2021-08-02
drwxr-xr-x 2 root root 25 8月  3 2021 192.168.80.20_2021-08-03
drwxr-xr-x 2 root root 25 8月  4 2021 192.168.80.20_2021-08-04
drwxr-xr-x 2 root root 25 8月  5 2021 192.168.80.20_2021-08-05
drwxr-xr-x 2 root root 25 8月  6 2021 192.168.80.20_2021-08-06
drwxr-xr-x 2 root root 25 8月  7 2021 192.168.80.20_2021-08-07
drwxr-xr-x 2 root root 25 8月  8 2021 192.168.80.20_2021-08-08
drwxr-xr-x 2 root root 25 8月  9 2021 192.168.80.20_2021-08-09
drwxr-xr-x 2 root root 25 8月  10 2021 192.168.80.20_2021-08-10
drwxr-xr-x 2 root root 25 8月  11 2021 192.168.80.20_2021-08-11
drwxr-xr-x 2 root root 25 8月  12 2021 192.168.80.20_2021-08-12
drwxr-xr-x 2 root root 25 8月  13 2021 192.168.80.20_2021-08-13
drwxr-xr-x 2 root root 25 8月  14 2021 192.168.80.20_2021-08-14
drwxr-xr-x 2 root root 25 8月  15 2021 192.168.80.20_2021-08-15
drwxr-xr-x 2 root root 25 8月  16 2021 192.168.80.20_2021-08-16
drwxr-xr-x 2 root root 25 8月  17 2021 192.168.80.20_2021-08-17
drwxr-xr-x 2 root root 25 8月  18 2021 192.168.80.20_2021-08-18
drwxr-xr-x 2 root root 25 8月  19 2021 192.168.80.20_2021-08-19
drwxr-xr-x 2 root root 25 8月  20 2021 192.168.80.20_2021-08-20
drwxr-xr-x 2 root root 25 8月  21 2021 192.168.80.20_2021-08-21
drwxr-xr-x 2 root root 25 8月  22 2021 192.168.80.20_2021-08-22
drwxr-xr-x 2 root root 25 8月  23 2021 192.168.80.20_2021-08-23
drwxr-xr-x 2 root root 25 8月  24 2021 192.168.80.20_2021-08-24
drwxr-xr-x 2 root root 25 8月  25 2021 192.168.80.20_2021-08-25
drwxr-xr-x 2 root root 25 8月  26 2021 192.168.80.20_2021-08-26
drwxr-xr-x 2 root root 25 8月  27 2021 192.168.80.20_2021-08-27
drwxr-xr-x 2 root root 25 8月  28 2021 192.168.80.20_2021-08-28
drwxr-xr-x 2 root root 25 8月  29 2021 192.168.80.20_2021-08-29
drwxr-xr-x 2 root root 25 8月  30 2021 192.168.80.20_2021-08-30
```