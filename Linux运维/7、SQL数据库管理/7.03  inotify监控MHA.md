# Masterha-manager避免自动关闭的方法

**在MySQL服务MHA架构中，master-manager在故障切换之后，就会自动关闭。对余下的主从架构的高可用监控就会失效**

**需要手动重启，才会继续监控，这不是我们想要的。**

# 解决办法

**当MHA有任何动向时，会向日志内写入信息，那这样的话，我们可以使用inotify文件监控，去监控日志文件**

**当发现日志文件更新时，自动检查masterha的状态，如果停止运行，我们就重新启动，当然了不能这么直接，还需要经过一系列的检查，比如从服务器的复制状态，一切没问题之后，脚本自动启动。**

# 脚本内容

> 还有一件事：
>
> 1.  此脚本内容，完全个人编写原创，如有部分BUG，在所难免。
> 2.  如有发现bug,或者有漏洞的地方，欢迎指正

*   **inotify\_log.sh**

    ```shell
    #!/usr/bin/bash
    set -u
    mha_conf=/etc/mha/app1.conf
    mha_log=/data/mha/masterha/app1/app1-3306.log
    function find_str {             #参数：$1,要查找的文件路径。$2:要查找的关键字。
            for i in {1..40}	#默认等待30秒
            do
                    num=$( tail $1 -n1 |grep -E "$2" -c )
                    [ "$num" -eq 1 ]&& break
                    sleep 1

            done
            if [ "$num" -ne 1 ];then
                    echo "运行出错！！！"
                    exit
            fi
            echo "finished"
    }


    /usr/bin/inotifywait -mq -e modify,attrib $mha_log |while read events
    do
        /usr/bin/masterha_check_status --conf=$mha_conf
        if [ $? -eq 0 ];then
    	echo "MHA 运行中"
        else
    	pkill inotifywait
    	find_str $mha_log  successfully
        for item in 1 2 3
        do
    	echo "MHA 准备重启"
    	masterha_check_repl --conf=$mha_conf &>/dev/null
    	if [ "$?" -eq 0  ];then
    	nohup /usr/bin/masterha_manager --conf=$mha_conf --remove_dead_master_conf --ignore_last_failover &
    		tag="$?"
    		find_str $mha_log  ".+succeeded.+respond"
    		
    		if [ "$tag" -eq 0  ];then
    			echo "MHA 启动成功"
    			 source $0 &
    			exit		
    		fi
    	fi
    	echo "MHA 启动失败"
    	sleep 1
        done
       fi
    done

    ```

# 使用方法

*   \*\*第一步：开启MHA 监控 \*\*

    ```shel
    nohup masterha_manager --conf=/etc/mha/app1.conf --remove_dead_master_conf --ignore_last_failover &

    # 注意，一定要加 --remove_dead——master_conf
    #	-当旧的master挂掉之后，自动删除它的配置信息。
    #	  如果不删，后面检查不会通过的。
    ```

*   **第二步：更改脚本**

    ```shell
    vim inotify_log.sh

    mha_conf=/etc/mha/app1.conf			#这里更改为你自己的配置文件的路径
    mha_log=/data/mha/masterha/app1/app1-3306.log	#这里改为你自己的日志文件路径，其他不变

    ```

*   **第三步：启动脚本**

    ```shell
    nohup ./inotify_log.sh &

    # 启动后，如果发现日志文件更新，再检测MHA状态后，
    #	-如果发现MHA，处于运行状态，
    #		会输出“MHA 在运行”
    #	- 如果发现MHA停止运行，会有一些列提示信息
    #		大约十几秒过后，MHA 就会再次正常启动
    ```

# 注意事项

1.  **一定要先确保MHA先正常开启，才可运行脚本**

2.  **注意，只能是由故障切换导致的MHA 停止运行，此脚本才起作用，如果是人为关闭MHA，此脚本将会自动停止服务**

3.  **挂掉的master，如果需要重新加入MHA架构，重启后，需要手动配置，本脚不支持自动加入**

