**日志管理**

# 1、错误日志（log_error）

错误日志是用来记录MySQL数据库的启动、关闭、日常运行过程中、状态信息、警告、错误等信息

- 查看错误日志文件位置

```
MariaDB [(none)]> show variables like 'log_error';
+---------------+------------------------------+
| Variable_name | Value            |
+---------------+------------------------------+
| log_error   | /var/log/mariadb/mariadb.log |
+---------------+------------------------------+
1 row in set (0.00 sec)
```

# 2、二进制日志（binlog）

备份恢复必须以来二进制日志，主从环境必须以来二进制日志。binlog是SQL层的功能，记录的是变更

的sql语句，不记录查询语句。

## 1）开启二进制日志

```
vim /etc/my.cnf
server_id=6                 # 设置id       
log_bin=mysql-bin            # 开启并指定二进制日志目录及前缀名，记得关闭
selinux 
binlog_format=row                           # binlog
的日志记录格式
修改完配置重启服务会自动生成二进制日志
```

- 日志记录方式

- SBR(statement based replication) ：语句模式原封不动的记录当前DML，5.6默认。

- RBR(ROW based replication) ：记录数据行的变化(用户看不懂，需要工具分析)，5.7默认。

- mixed（混合）MBR(mixed based replication)模式 ：以上两种模式的混合

- SBR模式与RBR模式的对比（面试题）

- SBR：可读性较高，日志量少，但是不够严谨

- ROW：可读性很低，日志量大，足够严谨（建议使用）

- event事件简介

```
二进制日志的最小记录单元
对于DDL,DCL,一个语句就是一个event
对于DML语句来讲:只记录已提交的事务。
例如以下列子,就被分为了4个event
begin;    120  - 340
DML1     340  - 460
DML2     460  - 550
commit;   550  - 760
```

## 2)查看日志的开启情况

```
MariaDB [(none)]>show variables like '%log_bin%';
+---------------------------------+------------------------------+
| Variable_name          | Value            |
+---------------------------------+------------------------------+
| log_bin             | ON              |
| log_bin_basename        | /data/binlog/mysql-bin    |
| log_bin_index          | /data/binlog/mysql-bin.index |
| log_bin_trust_function_creators | OFF             |
| log_bin_use_v1_row_events    | OFF             |
| sql_log_bin           | ON              |
+---------------------------------+------------------------------+
6 rows in set (0.01 sec)
```

## 3)查看二进制日志文件数量

```
MariaDB [(none)]>show binary logs;
+------------------+-----------+
| Log_name     | File_size |
+------------------+-----------+
| mysql-bin.000001 |    154 |
+------------------+-----------+
1 row in set (0.01 sec)
MariaDB [(none)]>flush logs;
Query OK, 0 rows affected (0.03 sec)
MariaDB [(none)]>flush logs;
Query OK, 0 rows affected (0.01 sec)
MariaDB [(none)]>show binary logs;
+------------------+-----------+
| Log_name     | File_size |
+------------------+-----------+
| mysql-bin.000001 |    201 |
| mysql-bin.000002 |    201 |
| mysql-bin.000003 |    154 |
+------------------+-----------+
3 rows in set (0.00 sec)
```

## 4)查看正在使用的二进制日志文件

```
MariaDB [(none)]> show master status;
+------------------+----------+--------------+------------------+------------
-------+
| File       | Position | Binlog_Do_DB | Binlog_Ignore_DB |
Executed_Gtid_Set |
+------------------+----------+--------------+------------------+------------
-------+
| mysql-bin.000003 |    154 |       |         |      
   |
+------------------+----------+--------------+------------------+------------
-------+
```

## 5)日志内容查看

```
MariaDB [binlog]>show binlog events in 'mysql-bin.000003';
+------------------+-----+----------------+-----------+-------------+-------
---------------------------------+
| Log_name     | Pos | Event_type   | Server_id | End_log_pos | Info 
                |
+------------------+-----+----------------+-----------+-------------+-------
---------------------------------+
| mysql-bin.000003 |  4 | Format_desc  |     6 |     123 | Server
ver: 5.7.20-log, Binlog ver: 4 |
| mysql-bin.000003 | 123 | Previous_gtids |     6 |     154 |   
                |
| mysql-bin.000003 | 154 | Anonymous_Gtid |     6 |     219 | SET
@@SESSION.GTID_NEXT= 'ANONYMOUS'  |
| mysql-bin.000003 | 219 | Query     |     6 |     319 | create
database binlog         |
| mysql-bin.000003 | 319 | Anonymous_Gtid |     6 |     384 | SET
@@SESSION.GTID_NEXT= 'ANONYMOUS'  |
| mysql-bin.000003 | 384 | Query     |     6 |     486 | use
`binlog`; create table t1 (id int) |
+------------------+-----+----------------+-----------+-------------+-------
---------------------------------+
Log_name：binlog文件名
Pos：开始的position  *****
Event_type：事件类型
Format_desc：格式描述，每一个日志文件的第一个事件，多用户没有意义，MySQL识别binlog必要
信息
Server_id：mysql服务号标识
End_log_pos：事件的结束位置号 *****
Info：事件内容*****
补充:
SHOW BINLOG EVENTS
 [IN 'log_name']
 [FROM pos]
 [LIMIT [offset,] row_count]
```

## 6)binlog内容详细查看

```
[root@localhost ~]# mysqlbinlog --base64-output=decode-rows -vvv
/data/binlog/mysql-bin.000003
```

## 7)基于position进行二进制日志截取

```
[root@localhost ~]# mysqlbinlog --start-position=219 --stop-position=1347
/data/binlog/mysql-bin.000003 >/tmp/bin.sql
```

## 8)案例，使用二进制日志文件进行恢复数据

### 故障模拟

```
创建了一个库 db, 导入了表t1 ,t1表中录入了很多数据
一个开发人员,drop database db;
没有备份,日志都在.怎么恢复?
思路:找到建库语句到删库之前所有的日志,进行恢复.(开启了GTID模式)
故障案例模拟:
(0) drop database if exists db ;
(1) create database db charset utf8;  
(2) use db;
(3) create table t1 (id int);
(4) insert into t1 values(1),(2),(3);
(5) insert into t1 values(4),(5),(6);
(6) commit
(7) update t1 set id=30 where id=3;
(8) commit;
(9) delete from t1 where id=4;
(10)commit;
(11)insert into t1 values(7),(8),(9);
(12)commit;
(13)drop database db;
========================
drop database if exists db ;
create database db charset utf8;
use db;
create table t1 (id int);
insert into t1 values(1),(2),(3);
insert into t1 values(4),(5),(6);
commit;
update t1 set id=30 where id=3;
commit;
delete from t1 where id=4;
commit;
insert into t1 values(7),(8),(9);
commit;
drop database db;
=======
运行以上语句，模拟故障场景
需求：将数据库恢复到以下状态（提示第9步和第13步是误操作，其他都是正常操作）
```

### 查看正在使用的二进制日志

```
MariaDB [(none)]> show master status ;
......
mysql-bin.000006
.....
```

### 查看事件

```
MariaDB [binlog]>show binlog events in 'mysql-bin.000006';
......
```

### 日志截取

```
[root@localhost ~]# mysqlbinlog --start-position=1568 --stop-position=1762
/data/mysql/mysql-bin.000006 >/tmp/bin2.sql
```

### 恢复

```
MariaDB [(none)]> set sql_log_bin=0;         # 恢复过程临时关闭日志记录
MariaDB [(none)]> source /tmp/bin1.sql
MariaDB [(none)]> source /tmp/bin2.sql
MariaDB [(none)]> set sql_log_bin=1;
```

# 3、慢日志slow_log

慢日志文件是记录运行比较慢的sql语句，将这些sql语句记录下来以便进一步优化。可以自行补充一些

关于慢日志的分析。

## 1）修改配置文件开启慢日志

```
开关:
slow_query_log=1
文件位置及名字
slow_query_log_file=/data/mysql/slow.log
设定慢查询时间:
long_query_time=0.1
没走索引的语句也记录:
log_queries_not_using_indexes
[root@localhost ~]# vim /etc/my.cnf
 slow_query_log=1
 slow_query_log_file=/data/mysql/slow.log
 long_query_time=0.1
log_queries_not_using_indexes
[root@localhost ~]# systemctl restart mysqld
```