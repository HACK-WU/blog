**事务特性**

# 1、特点

- 把数据库从一种一致性状态转换为另一种一致性状态，来保证数据库的完整性

- 主要用于处理操作量大，复杂高的数据

- 在MySQL中只有使用了Innodb数据库引擎的数据库或表才支持事务

- 事务处理可以用来维护数据库的完整性，保证成批的sql语句要么全部执行，要么全部不执行。全

部执行称为事务提交，全部不执行称为事务回滚。

- 事务主要用于管理insert、update、delete

# 2、ACID特性

- 一般来说，事务必须满足四个特性（ACID）

- A：原子性，事务必须是执行任务的最小原子单位，事务要么成功要么撤回

- C：一致性，事务是把数据库从一个一致性状态转化为另一个一致性状态

- I：隔离性，每个事务之间是隔离的

- D：持久性，事务一旦执行，数据的修改是永久的

# 3、四个隔离等级

- read uncommitted（未提交读）：出现脏读的现象

- read conmitted （提交读）：能够解决脏读，修改数据时会加锁。会出现幻读现象

- repeatable read （可重读）：能够解决幻读现象

- serializable（可串行化读）：事务需要按串行化解决（MVCC）

Innodb存储引擎默认可重复读

```
mysql>begin； ＃开始一个事务
mysql>insert into a (a) values(555);
mysql>rollback; #回滚，这样数据是不会写入的
mysql>commit; #提交事务
```

## 1）事务案例

### 创建一个表并插入数据

```
MariaDB [db1]> create table user(id int primary key auto_increment,memory
int unsigned);
Query OK, 0 rows affected (0.00 sec)
MariaDB [db1]> insert into user values (0,500), (0,100), (0,0);
Query OK, 3 rows affected (0.00 sec)
Records: 3 Duplicates: 0 Warnings: 0
MariaDB [db1]> select * from user;
+----+--------+
| id | memory |
+----+--------+
|  1 |   500 |
|  2 |   100 |
|  3 |    0 |
+----+--------+
3 rows in set (0.00 sec)
```

### 查看事务变量

```
MariaDB [db1]> show variables like '%commit%';
+-------------------------------------------+-------+
| Variable_name               | Value |
+-------------------------------------------+-------+
| aria_group_commit             | none |
| aria_group_commit_interval        | 0   |
| autocommit                | ON  |
| innodb_commit_concurrency         | 0   |
| innodb_flush_log_at_trx_commit      | 1   |
| innodb_use_global_flush_log_at_trx_commit | ON  |
+-------------------------------------------+-------+
6 rows in set (0.00 sec)
# 如果需要关闭自动提交的话可以在会话端通过 set autocommit=0或者在配置文件中添加参数
autocommit=0
```

### 开启事务，开启事务时不会自动提交，操作处于内存当中

```
MariaDB [db1]> begin;
Query OK, 0 rows affected (0.00 sec)
MariaDB [db1]> update user set memory=memory - 250 where id = 1;
Query OK, 1 row affected (0.00 sec)
Rows matched: 1 Changed: 1 Warnings: 0
MariaDB [db1]> select * from user;
+----+--------+
| id | memory |
+----+--------+
|  1 |   250 |
|  2 |   100 |
|  3 |    0 |
+----+--------+
3 rows in set (0.01 sec)
MariaDB [db1]> rollback;
Query OK, 0 rows affected (0.00 sec)
MariaDB [db1]> select * from user;
+----+--------+
| id | memory |
+----+--------+
|  1 |   500 |
|  2 |   100 |
|  3 |    0 |
+----+--------+
3 rows in set (0.00 sec)
```

### 同时开启两个事务，另一个事务会卡住，这是事务的隔离性决定的

```
MariaDB [db1]> begin;
Query OK, 0 rows affected (0.00 sec)
MariaDB [db1]> update user set memory=memory - 250 where id = 1;
Query OK, 1 row affected (0.01 sec)
Rows matched: 1 Changed: 1 Warnings: 0
```

![](images/WEBRESOURCE8ca172b355116a76902f592f86a6bb43截图.png)

结束事务的两种方式是commit或者rollback