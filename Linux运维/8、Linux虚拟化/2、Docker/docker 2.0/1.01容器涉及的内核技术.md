**容器涉及的内核技术**

# 1、一个容器就是一个NameSpace（命名空间）

- UTS

UTS（UNIX Time-sharing System）命名空间允许每个容器拥有独立的主机名和域名，从而可以虚拟出一个有独立主机名和网络空间的环境，就跟网络上一台独立的主机一样。

- IPC

容器中进程交互还是采用了Linux常见的进程间交互方法（Interprocess Communication，IPC），包括信号量、消息队列和共享内存等。PID Namespace和IPC Namespace可以组合起来一起使用，同一个IPC命名空间内的进程可以彼此可见，允许进行交互；不同空间的进程则无法交互。

- Mount

类似于chroot，将一个进程放到一个特定的目录执行。挂载命名空间允许不同命名空间的进程看到的文件结构不同，这样每个命名空间中的进程所看到的文件目录彼此被隔离。

- Net

通过网络命名空间，可以实现网络隔离。网络命名空间为进程提供了一个完全独立的网络协议栈的视图，包括网络设备接口、IPv4和IPv6协议栈、IP路由表、防火墙规则、sockets等，这样每个容器的网络就能隔离开来。Docker采用虚拟网络设备（Virtual Network Device）的方式，将不同命名空间的网络设备连接到一起。默认情况下，容器中的虚拟网卡将同本地主机上的docker0网桥连接在一起。

# 2、CGroups资源限制

## **1）相关说明**

**控制组**

具体来看，控制组提供：

- **资源限制（Resource limiting）：**可以将组设置为不超过设定的内存限制。比如：内存子系统可以为进程组设定一个内存使用上限，一旦进程组使用的内存达到限额再申请内存，就会出发Out of Memory警告。

- **优先级（Prioritization）**：通过优先级让一些组优先得到更多的CPU等资源。

- **资源审计（Accounting）**：用来统计系统实际上把多少资源用到适合的目的上，可以使用cpuacct子系统记录某个进程组使用的CPU时间。

- **隔离（isolation）：**为组隔离命名空间，这样一个组不会看到另一个组的进程、网络连接和文件系统。

- **控制（Control）**：挂起、恢复和重启动等操作。

- **Croups**

- 控制组

- 作用：用于实现容器的资源隔离

- 可对进程做资源隔离

- 9大子系统

- 把linux中的资源定义为子系统，可以通过子系统对资源进行限制

- CPU可

- 应用案例

- **扩展**

- 主机虚拟化实现资源隔离的方式

- 使用Hypervisor中的VMM实现资源隔离

- PAM

- 用户认证

- 资源限制

- ulimit

- 仅对用户做资源限制

## 2)讲解案例：

cgroups: Control Group

基于进程的限制，而非用户，因此对于超户运行的进程也是一样

cgroup将各种子系统定义为资源，命名为controller：

可配额/可度量 - Control Groups (cgroups)

cgroups实现了对资源的配额和度量九大子系统的资源

```
1.blkio       #限制每个块设备的输入输出控制。例如:磁盘,光盘以及usb
2.cpu         #限制使用cpu比例
3.cpuacct    #产生cgroup任务的cpu资源报告。
4.cpuset     #多核心的cpu时为cgroup任务分配单独的cpu和内存
5.devices    #允许或拒绝对设备的访问。
6.freezer     #暂停和恢复cgroup任务。
7.memory      #设置内存限制以及产生内存资源报告。
8.net_cls     #标记每个网络包。
9.ns          #名称空间子系统
```