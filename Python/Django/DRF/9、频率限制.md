# **三 限流Throttling**

**可以对接口访问的频次进行限制，以减轻服务器压力。**

**一般用于付费购买次数,投票等场景使用.**

## **3.1 自定义频率类**

### **3.1.1 编写频率类**

```python
**# 自定义的逻辑**
**#（1）取出访问者ip**
**#（2）判断当前ip不在访问字典里，添加进去，并且直接返回True,表示第一次访问，在字典里，继续往下走**
**#（3）循环判断当前ip的列表，有值，并且当前时间减去列表的最后一个时间大于60s，把这种数据pop掉，这样列表中只有60s以内的访问时间，**
**#（4）判断，当列表小于3，说明一分钟以内访问不足三次，把当前时间插入到列表第一个位置，返回True，顺利通过**
**#（5）当大于等于3，说明一分钟内访问超过三次，返回False验证失败**
**class MyThrottles():**
**    VISIT_RECORD = {}**
**    def __init__(self):**
**        self.history=None**
**    def allow_request(self,request, view):**
**        #（1）取出访问者ip**
**        # print(request.META)**
**        ip=request.META.get('REMOTE_ADDR')**
**        import time**
**        ctime=time.time()**
**        # （2）判断当前ip不在访问字典里，添加进去，并且直接返回True,表示第一次访问**
**        if ip not in self.VISIT_RECORD:**
**            self.VISIT_RECORD[ip]=[ctime,]**
**            return True**
**        self.history=self.VISIT_RECORD.get(ip)**
**        # （3）循环判断当前ip的列表，有值，并且当前时间减去列表的最后一个时间大于60s，把这种数据pop掉，这样列表中只有60s以内的访问时间，**
**        while self.history and ctime-self.history[-1]>60:**
**            self.history.pop()**
**        # （4）判断，当列表小于3，说明一分钟以内访问不足三次，把当前时间插入到列表第一个位置，返回True，顺利通过**
**        # （5）当大于等于3，说明一分钟内访问超过三次，返回False验证失败**
**        if len(self.history)<3:**
**            self.history.insert(0,ctime)**
**            return True**
**        else:**
**            return False**
**    def wait(self):**
**        import time**
**        ctime=time.time()**
**        return 60-(ctime-self.history[-1])**
```

### **3.1.2 全局使用**

```bash
**REST_FRAMEWORK = {**
**    'DEFAULT_THROTTLE_CLASSES':['app01.utils.MyThrottles',],**
**}**
```

### **3.1.3 局部使用**

```
**#在视图类里使用**
**throttle_classes = [MyThrottles,]**
```

## **3.2 内置频率类**

### **3.2.1 根据用户ip限制**

```python
**#写一个类，继承自SimpleRateThrottle，（根据ip限制）**
**from rest_framework.throttling import SimpleRateThrottle**
**class VisitThrottle(SimpleRateThrottle):**
**    scope = 'luffy'**
**    def get_cache_key(self, request, view):**
**        return self.get_ident(request)**
**#在setting里配置：（一分钟访问三次）**
**REST_FRAMEWORK = {**
**    'DEFAULT_THROTTLE_RATES':{**
**        'luffy':'3/m'  # key要跟类中的scop对应**
**    }**
**}**
**# 可以全局使用，局部使用**
```

**了解：错误信息中文显示**

```python
**class Course(APIView):**
**    authentication_classes = [TokenAuth, ]**
**    permission_classes = [UserPermission, ]**
**    throttle_classes = [MyThrottles,]**
**    def get(self, request):**
**        return HttpResponse('get')**
**    def post(self, request):**
**        return HttpResponse('post')**
**    def throttled(self, request, wait):**
**        from rest_framework.exceptions import Throttled**
**        class MyThrottled(Throttled):**
**            default_detail = '傻逼啊'**
**            extra_detail_singular = '还有 {wait} second.'**
**            extra_detail_plural = '出了 {wait} seconds.'**
**        raise MyThrottled(wait)**
```

### **3.2.2 限制匿名用户每分钟访问3次**

```go
**REST_FRAMEWORK = {**
**    'DEFAULT_THROTTLE_CLASSES': (**
**        'rest_framework.throttling.AnonRateThrottle',**
**    ),**
**    'DEFAULT_THROTTLE_RATES': {**
**        'anon': '3/m',**
**    }**
**}**
**# 使用 `second`, `minute`, `hour` 或`day`来指明周期。**
**# 可以全局使用，局部使用**
```

### **3.2.3 限制登陆用户每分钟访问10次**

```bash
**REST_FRAMEWORK = {**
**    'DEFAULT_THROTTLE_CLASSES': (**
**        'rest_framework.throttling.UserRateThrottle'**
**    ),**
**    'DEFAULT_THROTTLE_RATES': {**
**        'user': '10/m'**
**    }**
**}**
**# 可以全局使用，局部使用**
```

### **3.2.4 其他**

**1） AnonRateThrottle**

**限制所有匿名未认证用户，使用IP区分用户。**

**使用**

**2）UserRateThrottle**

**限制认证用户，使用User id 来区分。**

**使用**

**3）ScopedRateThrottle**

**限制用户对于每个视图的访问频次，使用ip或user id。**

**例如：**

```java
**class ContactListView(APIView):**
**    throttle_scope = 'contacts'**
**    ...**
**class ContactDetailView(APIView):**
**    throttle_scope = 'contacts'**
**    ...**
**class UploadView(APIView):**
**    throttle_scope = 'uploads'**
**    ...**
**REST_FRAMEWORK = {**
**    'DEFAULT_THROTTLE_CLASSES': (**
**        'rest_framework.throttling.ScopedRateThrottle',**
**    ),**
**    'DEFAULT_THROTTLE_RATES': {**
**        'contacts': '1000/day',**
**        'uploads': '20/day'**
**    }**
**}**
```

## **实例**

**全局配置中设置访问频率**

```python
**'DEFAULT_THROTTLE_RATES': {**
**    'anon': '3/minute',**
**    'user': '10/minute'**
**}**
**from rest_framework.authentication import SessionAuthentication**
**from rest_framework.permissions import IsAuthenticated**
**from rest_framework.generics import RetrieveAPIView**
**from rest_framework.throttling import UserRateThrottle**
**class StudentAPIView(RetrieveAPIView):**
**    queryset = Student.objects.all()**
**    serializer_class = StudentSerializer**
**    authentication_classes = [SessionAuthentication]**
**    permission_classes = [IsAuthenticated]**
**    throttle_classes = (UserRateThrottle,)**
```