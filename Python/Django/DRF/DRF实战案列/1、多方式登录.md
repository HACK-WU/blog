# v1

> 实现手机号，邮箱，用户名登录
> 并进行使用jwt模块，进行Token签发


## views

```python
from lufeiapi.utils.response import APIResponse
from rest_framework.viewsets import ViewSet
from rest_framework.decorators import action
from . import serializer
class LoginView(ViewSet):
    @action(methods=['POST'], detail=False)
    def login(self, request):
        ser = serializer.UserSerializer(data=request.data)
        if ser.is_valid():
            token = ser.context['token']
            username = ser.context['user'].username
            return APIResponse(token=token, username=username)
        return APIResponse(code=0, msg=ser.errors)
```

## urls

```python
from rest_framework.routers import SimpleRouter
from . import views
router = SimpleRouter()
router.register('', views.LoginView, basename='login')
```

## seralizer

```python
from rest_framework import serializers
from rest_framework_jwt.serializers import jwt_payload_handler, jwt_encode_handler
from . import models
import re
class UserSerializer(serializers.ModelSerializer):
    username = serializers.CharField()
    class Meta:
        model = models.User
        fields = ('id', 'username', 'password')
        extra_kwargs = {
            'id': {'read_only': True},
            'password': {'write_only': True}
        }
    def validate(self, attrs):
        user = self._get_user(attrs)
        # 签发token
        token = self._get_token(user)
        # 将Token和user返对象存在放在context中，在CBV中可以获取到
        self.context["token"] = token
        self.context["user"] = user
        return attrs
    def _get_user(self, attrs):
        username = attrs.get('username')
        password = attrs.get('password')
        # 多种登录方式
        if re.match(r'^1[3-9]\d{9}$', username):
            user = models.User.objects.filter(telephone=username).first()
        # 匹配邮箱表达式
        elif re.match(r'^.*@.*', username):
            user = models.User.objects.filter(email=username).first()
        else:
            user = models.User.objects.filter(username=username).first()
        if user:
            result = user.check_password(password)
            if result:
                return user
            raise serializers.ValidationError('密码错误')
        raise serializers.ValidationError('用户不存在')
    def _get_token(self, user):
        payload = jwt_payload_handler(user)
        token = jwt_encode_handler(payload)
        return token
```