# test.html

```
<!--************************************评 论 楼*****************************************-->
    <div class="">
        <ul class="list-group">
            {% for comment in comment_list %}
            <li class="list-group-item" >
            <span>#{{ forloop.counter }}楼</span>
            <span>{{ comment.comment_time|date:"Y-m-d h:i:s" }}</span>
            <span>{{ comment.user.username }}</span>
            <span><a  class="pull-right replay" username="{{ request.user.username }}" comment_id="{{ comment.pk }}">回复</a></span>
            <div>
                <!--判断当前评论是否是子评论，如果是子评论需要渲染对应的评论人的人名-->
                {% if comment.parent_id %}
                    <p>@{{ comment.parent.user.username }}</p>
                {% endif %}
                {{ comment.content }}
            </div>
         </li>
        {% endfor %}
        </ul>
    </div>
<!--***********************************文章评论***************************************-->
    <div class="">
    <p><span class="glyphicon glyphicon-comment">发表评论</span></p>
        {% if request.user.is_authenticated %}
    <div class="">
        <textarea name="comment" id="id_comment" cols="60" rows="10"></textarea>
    </div>
            {% else %}
            <li><a href="{% url "reg" %}">注册</a></li> <!--使用的是url别名-->
            <li><a href="{% url "login" %}">登录</a></li>
        {% endif %}
        <button class="btn btn-primary" id="id_submit">提交评论</button>
        <span style="color: red" id="error"></span>    <!--提示信息-->
    </div>
 <!--**********************************文章评论jQuery*********************************************-->
<script>
/*
 **********************************文章评论*********************************************
 */
    //设置一个全局的parentId字段
    let parentId=null;
    //用户点击评论给后盾发送ajax请求
    $("#id_submit").click(function () {
        //获取用户评论的内容
        let conTent=$("#id_comment").val();
        //判断当前评论是否是子评论 如果是我们要将手动渲染的@username去掉
        if(parentId){
            //先找到\n对应的所有值， 然后利用切片 但是切片顾前不顾尾 所以索引+1
            let indexNum=conTent.indexOf("\n")+1;
            conTent=conTent.slice(indexNum)     //将indxNum之前的所有数据切除，只保留后面的部分
        }
        $.ajax({
            url:"/comment/",
            type:"post",
            data:{
              "article_id":"{{ article_obj.pk }}",
                "parent_id":parentId,   //如果parentId没有值，置为null
              "content":conTent,
                "csrfmiddlewaretoken":"{{ csrf_token }}"
            },
            success:function (args) {
                if(args.code==1000){
                    $("#error").text(args.msg);
                    //1、将评论框里的内容清空
                    $("#id_comment").val("");
                    //2、临时渲染评论楼
                    let userName="{{ request.user.username }}";
                    let t=  `
                       <li class="list-group-item" >
                        <b>${userName}</b>
                        <span><a href="" class="pull-right">回复</a></span>pi
                        <div>
                           <b>${conTent}</b>
                        </div>
                        </li>
                    `;
                    //将生成好的标签，添加到ul标签内
                    $(".list-group").append(t);
                    //清空全局的parentId
                    parentId=null;
                }
            }
        })
    })
/*
 ************************************评论回复*************************************
 */
//给回复按钮绑定点击事件
$(".replay").click(function () {
    //需要评论对应的评论人姓名 还需要评论的主键值
    //获取用户名
    let commentUserName=$(this).attr("username");
    //获取主键值 直接修改全局的变量名
     parentId=$(this).attr("comment_id");
    //将信息塞给评论框
    $("#id_comment").val("@"+commentUserName+"\n").focus();
})
</script>
```

# views.py

```
from app01 import models
from django.http import JsonResponse
from django.contrib import  auth
from django.db  import transaction
def comment(request):
    #自己可以评论自己的文章
    if request.method=="POST":
        back_dic={"code":1000,"msg":""}
        if request.user.is_authenticated:
            article_id=request.POST.get("article_id")
            content=request.POST.get("content")
            parent_id=request.POST.get("parent_id")
            #直接操作评论表存储数据  两张表
            with transaction.atomic():
                models.Article.objects.filter(pk=article_id).update(comment_num=F("comment_num")+1)
                models.Comment.objects.create(user=request.user,article_id=article_id,content=content,parent_id=parent_id)
                back_dic["msg"]="评论成功"
        else:
            back_dic["code"]=2000
            back_dic["msg"]="未登录"
        return JsonResponse(back_dic)
```