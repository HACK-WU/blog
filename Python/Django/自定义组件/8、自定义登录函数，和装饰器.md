## login_auth 装饰器

```
current_user=set()        #一个集合，用于保存已经登录的用户
def login_auth(func):
    def inner(request,*args,**kwargs):
        if request.COOKIES.get("qwer"):
            user=logined_user(request)        #获取cookie中的用户名，查看是否在本地记录中，如果没有记录，也要重新登录
            if user not in current_user:       
                return redirect("/login/")
            return func(request,*args,**kwargs)
        else:
            return redirect("/login/")
    return inner
```

# login 登录函数

```
def login(request):
    username=None
    passwd=None
    error_msg=""
    if request.method == 'POST':
        username=request.POST.get('username')
        passwd=request.POST.get('passwd')
        if authenUser(username,passwd):        #authen() 自定义，用于验证用户密码是否正确
            token=encrypt(username)            #如果正确，对用户名进行加密，获得token，ecrypt() 加密函数，是自定义的
            obj=redirect('/index/')
            obj.set_cookie("qwer",token)       #将qwer:token 键值对，作为cookie传给浏览器
            current_user.add(username)         #将验证通过的用户名加入到current_user集合中
            # obj.set_signed_cookie(username,"1234qwer",salt=username)       
            return obj
        else:
            print('用户名或密码错误')
            error_msg="用户名或密码错误"
            return render(request,"login.html",locals())
    return render(request,"login.html")
```

# logout 退出函数

```
def login_out(request):
    user=logined_user(request)      #获取cokkie中保存的用户信息，这里是一个用户名
    current_user.remove(user)       #将记录的用户名删除
    obj=redirect('/login/')
    obj.delete_cookie("qwer")
    return obj
```

# 加密、解密、从cookie中，获取用户信息的函数

```
def encrypt(username):   #加密
    username=front+username+rear
    data=""
    for item in username:
        num=ord(item)+4
        data+=chr(num)
    return data
def decrypt(token):      #解密
    data=""
    for item in token:
        num=ord(item)-4
        data+=chr(num)
    data=data[len(front):len(data)-len(rear)]
    return data
    
def logined_user(request):        #获取cookie中获取到用户的信息
    token=request.COOKIES.get('qwer')    #新获取token
    user=decrypt(token)                #对token进行解密，就是用户的关键信息
    return user
```